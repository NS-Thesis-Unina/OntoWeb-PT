capture_deactivate() {
    if [ -n "${_OLD_VIRTUAL_PS1-}" ]; then
        PS1="${_OLD_VIRTUAL_PS1}"
        export PS1
        unset _OLD_VIRTUAL_PS1
        echo "[capture] Prompt deactivated"
    fi

    if (( CAPTURE_ACTIVE == 1 )); then
        echo "[capture] Moving back to root namespace..."
        sudo nsenter -t 1 -n true

        # Collect all PIDs in the namespace *from root*, not from inside
        pids=$(sudo ip netns pids "$VIRTUAL_ENV_PROMPT" 2>/dev/null)

        if [[ -n "$pids" ]]; then
            echo "[capture] Found active PIDs in '$VIRTUAL_ENV_PROMPT': $pids"
            echo "[capture] Terminating from root namespace..."
            for pid in $pids; do
                sudo nsenter -t 1 -n kill -9 "$pid" 2>/dev/null || true
            done
        fi

        # Clean up iptables rules (idempotent)
        sudo nsenter -t 1 -n iptables -t nat -D POSTROUTING -s 10.0.0.0/24 -j MASQUERADE 2>/dev/null
        sudo nsenter -t 1 -n iptables -D FORWARD -i veth-"$VIRTUAL_ENV_PROMPT" -j ACCEPT 2>/dev/null
        sudo nsenter -t 1 -n iptables -D FORWARD -o veth-"$VIRTUAL_ENV_PROMPT" -j ACCEPT 2>/dev/null

        # Delete namespace itself (now safe)
        sudo nsenter -t 1 -n ip netns delete "$VIRTUAL_ENV_PROMPT" 2>/dev/null || \
            echo "[capture] Warning: could not remove namespace '$VIRTUAL_ENV_PROMPT'"

        CAPTURE_ACTIVE=0
        echo "[capture] Cleanup complete."
    fi

    exit 0
}